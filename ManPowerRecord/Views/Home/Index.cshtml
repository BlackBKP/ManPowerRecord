@{
    ViewData["Title"] = "Home";
}
<div class="row p-3">
    <div class="col-xl-3 col-lg-3 col-md-4 pb-3">
        <select id="filter_job" class="form-control">
            <option>Please Select Job</option>
        </select>
    </div>
    <div class="col-xl-3 col-lg-3 col-md-4 pb-3">
        <select id="filter_task" class="form-control">
            <option>Please Select Task</option>
        </select>
    </div>
    <div class="col-xl-2 col-lg-2 col-md-4 pb-3">
        <button class="btn btn-primary form-control">
            <i class="fas fa-filter"></i> Filter
        </button>
    </div>
    <div class="col-12">
        <div class="card card-dark">
            <div class="card-header">
                <span class="card-title">Calendar</span>
            </div>
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Task Modal -->
<div class="modal fade" id="modal_task" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-xl modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal_task_title">Add Tasks</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="user_id">User</label>
                        <input id="user_id" type="text" class="form-control" placeholder="User ID" disabled/>
                    </div>
                    <div class="form-group">
                        <label for="working_date">Date</label>
                        <input id="working_date" type="date" class="form-control" />
                    </div>
                    <hr />
                    <div class="form-group row">
                        <div class="col-xl-3">
                            <label for="job_1">1). Job</label>
                            <select id="job_1" class="form-control">
                                <option value="" selected disabled>Please Select Job</option>
                                <option value="J201299">J20-1299 BTGNM</option>
                            </select>
                        </div>
                        <div class="col-xl-3">
                            <label for="task_1">Task</label>
                            <select id="task_1" class="form-control">
                                <option value="" selected disabled>Please Select Task</option>
                                <option>Task 1</option>
                            </select>
                        </div>
                        <div class="col-xl-3">
                            <label for="start_time1">Start Time</label>
                            <input id="start_time1" type="time" class="form-control" value="08:30" />
                        </div>
                        <div class="col-xl-3">
                            <label for="stop_time1">Stop Time</label>
                            <input id="stop_time1" type="time" class="form-control" value="17:30" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-xl-3">
                            <label for="job_2">2). Job</label>
                            <select id="job_2" class="form-control">
                                <option value="" selected disabled>Please Select Job</option>
                                <option value="J201299">J20-1299 BTGNM</option>
                            </select>
                        </div>
                        <div class="col-xl-3">
                            <label for="task_2">Task</label>
                            <select id="task_2" class="form-control">
                                <option value="" selected disabled>Please Select Task</option>
                                <option>Task 1</option>
                            </select>
                        </div>
                        <div class="col-xl-3">
                            <label for="start_time2">Start Time</label>
                            <input id="start_time2" type="time" class="form-control" />
                        </div>
                        <div class="col-xl-3">
                            <label for="stop_time2">Stop Time</label>
                            <input id="stop_time2" type="time" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-xl-3">
                            <label for="job_3">3). Job</label>
                            <select id="job_3" class="form-control">
                                <option value="" selected disabled>Please Select Job</option>
                                <option value="J201299">J20-1299 BTGNM</option>
                            </select>
                        </div>
                        <div class="col-xl-3">
                            <label for="task_3">Task</label>
                            <select id="task_3" class="form-control">
                                <option value="" selected disabled>Please Select Task</option>
                                <option>Task 1</option>
                            </select>
                        </div>
                        <div class="col-xl-3">
                            <label for="start_time3">Start Time</label>
                            <input id="start_time3" type="time" class="form-control" />
                        </div>
                        <div class="col-xl-3">
                            <label for="stop_time3">Stop Time</label>
                            <input id="stop_time3" type="time" class="form-control" />
                        </div>
                    </div>
                    <hr />
                    <div class="form-group">
                        <label>Break</label>
                    </div>
                    <div class="form-group row d-flex align-items-baseline">
                        <div class="col-2">
                            <div class="form-check">
                                <input id="lunch" type="checkbox" class="form-check-input" />
                                <label for="lunch" class="form-check-label">Lunch</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row d-flex align-items-baseline">
                        <div class="col-2">
                            <div class="form-check">
                                <input id="dinner" type="checkbox" class="form-check-input" />
                                <label for="dinner" class="form-check-label">Dinner</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="note">Note</label>
                        <input id="note" type="text" class="form-control" placeholder="Note or Description" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="btn_accept" type="button" class="btn btn-primary">Accept</button>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script type="text/javascript">

        $(document).ready(function () {
            GetHolidays().then(() => GetWorkingHours());
            GetJobs().then(() => GenerateJobFilterOptions()).then(() => GetTasks()).then(() => GenerateTasksFilterOptions());
            $('#table_holiday').DataTable();
        });

        var jobs = [];
        async function GetJobs() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetJobs", "Job")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                },
                success: function (response) {
                    jobs = response;
                }
            });
        };

        function GenerateJobFilterOptions() {
            $('#filter_job').empty();
            var job_str = '<option value="" selected disabled>Please Select Job</option>';
            for (var i = 0; i < jobs.length; i++) {
                job_str += '<option value="' + jobs[i].job_id + '">' + jobs[i].job_name + '</option>';
            }
            $('#filter_job').append(job_str);
        }

        $('#filter_job').on('change', function () {
            GenerateTasksFilterOptions();
        });

        var tasks = [];
        async function GetTasks() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetTasks", "Tasks")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                },
                success: function (response) {
                    tasks = response;
                }
            });
        };

        function GenerateTasksFilterOptions() {
            $('#filter_task').empty();
            var task_str = '<option value="" selected disabled>Please Select Task</option>';
            for (var i = 0; i < tasks.length; i++) {
                if(tasks[i].job_id == $('#filter_job').val())
                    task_str += '<option value="' + tasks[i].task_id + '">' + tasks[i].task_name + '</option>';
            }
            $('#filter_task').append(task_str);
        }

        var holidays = [];
        async function GetHolidays() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetHolidays", "Holiday")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                },
                success: function (response) {
                    //console.log("Holidays");
                    //console.log(response);
                    holidays = response;
                }
            });
        };

        async function GetWorkingHours() {
            await $.ajax({
                type: "GET",
                url: '@Url.Action("GetWorkingHours", "Home")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                },
                success: function (response) {
                    //console.log("Working Hours Data");
                    //console.log(response);
                    GenerateCalendar(response);
                }
            });
        };

        var calendar;
        var calendarEl;
        function GenerateCalendar(whs) {
            var datas = [];
            for (var i = 0; i < whs.length; i++) {
                var start_date = new Date(whs[i].working_date);
                datas.push(
                    {
                        title: whs[i].note,
                        start: start_date.setHours(whs[i].start_time1.split(":")[0], whs[i].start_time1.split(":")[1]),
                        end: start_date.setHours(whs[i].stop_time1.split(":")[0], whs[i].stop_time1.split(":")[1]),
                        allDay: false,
                        editable: false,
                        extendedProps: {
                            index: whs[i].index,
                            user_id: whs[i].user_id,
                            working_date: whs[i].working_date,
                            job_1: whs[i].job_1,
                            task_1: whs[i].task_1,
                            start_time1: whs[i].start_time1,
                            stop_time1: whs[i].stop_time1,
                            job_2: whs[i].job_2,
                            task_2: whs[i].task_2,
                            start_time2: whs[i].start_time2,
                            stop_time2: whs[i].stop_time2,
                            job_3: whs[i].job_3,
                            task_3: whs[i].task_3,
                            start_time3: whs[i].start_time3,
                            stop_time3: whs[i].stop_time3,
                            lunch: whs[i].lunch,
                            dinner: whs[i].dinner,
                            note: whs[i].note,
                        }
                    }
                );
            }

            //console.log("Calendar Events Data");
            //console.log(datas);
            calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'dayGridMonth,listMonth,timeGridWeek,timeGridDay',
                    center: 'title',
                    right: 'prev,next'
                },
                events: datas,
                height: 600,
                editable: true,
                selectable: true,
                select: function (info) {
                    var date_start = info.startStr;
                    var date_end = info.endStr;
                    AddTask(date_start, date_end)
                },
                eventClick: function (info) {
                    EditTask(info.event);
                },
            });

            var weekend = [
                {
                    daysOfWeek: [0, 6],
                    display: 'background',
                    color: "#CCCCCC",
                    allDay: true
                }
            ];
            calendar.addEventSource(weekend);

            var e_holidays = [];
            for (var i = 0; i < holidays.length; i++) {
                e_holidays.push(
                    {
                        id: holidays[i].no,
                        title: holidays[i].name,
                        start: holidays[i].date.split("T")[0],
                        display: 'background',
                        color: "#FF9999",
                        allDay: true
                    }
                );
            }
            calendar.addEventSource(e_holidays);
            calendar.render();
        }

        var update = false;
        function AddTask(date_start) {
            $('#modal_task').modal();
            $('#modal_task_title').text("Add Task");
            update = false;
            $('#user_id').val("Korakod.P");
            $('#working_date').val(date_start);
            $('#job_1').val();
            $('#task_1').val();
            $('#start_time1').val("08:30");
            $('#stop_time1').val("17:30");
            $('#lunch').prop('checked', true);
            $('#dinner').prop('checked', true);
            $('#note').val();
        }

        $('#btn_accept').on('click', function () {
            var user_id = $('#user_id').val();
            var working_date = $('#working_date').val();
            var job_1 = $('#job_1').val();
            var task_1 = $('#task_1').val();
            var start_time1 = $('#start_time1').val();
            var stop_time1 = $('#stop_time1').val();
            var job_2 = $('#job_2').val();
            var task_2 = $('#task_2').val();
            var start_time2 = $('#start_time2').val() !== "" ? $('#start_time2').val() : "00:00";
            var stop_time2 = $('#stop_time2').val() !== "" ? $('#stop_time2').val() : "00:00";
            var job_3 = $('#job_3').val();
            var task_3 = $('#task_3').val();
            var start_time3 = $('#start_time3').val() !== "" ? $('#start_time3').val() : "00:00";
            var stop_time3 = $('#stop_time3').val() !== "" ? $('#stop_time3').val() : "00:00";
            var lunch = $('#lunch').prop('checked');
            var dinner = $('#dinner').prop('checked');
            var note = $('#note').val();

            var debug = true;
            if (debug) {
                console.log("Add Task");
                console.log("User ID -> " + user_id);
                console.log("Date -> " + working_date);
                console.log("Job 1 -> " + job_1);
                console.log("Task -> " + task_1);
                console.log("From -> " + start_time1);
                console.log("To -> " + stop_time1);
                console.log("Job 2 -> " + job_2);
                console.log("Task -> " + task_2);
                console.log("From -> " + start_time2);
                console.log("To -> " + stop_time2);
                console.log("Job 3 -> " + job_3);
                console.log("Task -> " + task_3);
                console.log("From -> " + start_time3);
                console.log("To -> " + stop_time3);
                console.log("Lunch -> " + lunch);
                console.log("Dinner -> " + dinner);
                console.log("Note -> " + note);
            }

            if (update) {
                var wh_string = JSON.stringify({
                    "index": wh_index,
                    "user_id": user_id,
                    "working_date": working_date,
                    "job_1": job_1,
                    "task_1": task_1,
                    "start_time1": start_time1,
                    "stop_time1": stop_time1,
                    "job_2": job_2,
                    "task_2": task_2,
                    "start_time2": start_time2,
                    "stop_time2": stop_time2,
                    "job_3": job_3,
                    "task_3": task_3,
                    "start_time3": start_time3,
                    "stop_time3": stop_time3,
                    "lunch": lunch,
                    "dinner": dinner,
                    "note": note,
                });
                UpdateWorkingHours(wh_string);
            }
            else {
                var wh_string = JSON.stringify({
                    "user_id": user_id,
                    "working_date": working_date,
                    "job_1": job_1,
                    "task_1": task_1,
                    "start_time1": start_time1,
                    "stop_time1": stop_time1,
                    "job_2": job_2,
                    "task_2": task_2,
                    "start_time2": start_time2,
                    "stop_time2": stop_time2,
                    "job_3": job_3,
                    "task_3": task_3,
                    "start_time3": start_time3,
                    "stop_time3": stop_time3,
                    "lunch": lunch,
                    "dinner": dinner,
                    "note": note,
                });
                AddWorkingHours(wh_string);
            }
        });

        var wh_index;
        function EditTask(event) {
            var task = event.extendedProps;
            $('#modal_task').modal();
            $('#modal_task_title').text("Edit Task");
            update = true;
            wh_index = task.index;
            $('#user_id').val(task.user_id);
            $('#working_date').val(task.working_date.split("T")[0]);
            $('#job_1').val(task.job_1);
            $('#task_1').val(task.task_1);
            $('#start_time1').val(task.start_time1);
            $('#stop_time1').val(task.stop_time1);
            $('#job_2').val(task.job_2);
            $('#task_2').val(task.task_2);
            $('#start_time2').val(task.start_time2);
            $('#stop_time2').val(task.stop_time2);
            $('#job_3').val(task.job_3);
            $('#task_3').val(task.task_3);
            $('#start_time3').val(task.start_time3);
            $('#stop_time3').val(task.stop_time3);
            if (task.lunch) {
                $('#lunch').prop('checked', true);
            }
            else {
                $('#lunch').prop('checked', false);
            }
            if (task.dinner) {
                $('#dinner').prop('checked', true);
            }
            else {
                $('#dinner').prop('checked', false);
            }
            $('#note').val(task.note);
        }

        async function AddWorkingHours(wh_string) {
            await $.ajax({
                type: "POST",
                url: '@Url.Action("AddWorkingHours", "Home")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    wh_string
                },
                success: function (response) {
                    if (response == "Success")
                        location.reload();
                    else
                        alert(response);
                }
            });
        }

        async function UpdateWorkingHours(wh_string) {
            await $.ajax({
                type: "PATCH",
                url: '@Url.Action("EditWorkingHours", "Home")',
	            contentType: 'application/x-www-form-urlencoded',
                data: {
                    wh_string
                },
                success: function (response) {
                    if (response == "Success")
                        location.reload();
                    else
                        alert(response);
                }
            });
        }

    </script>
}